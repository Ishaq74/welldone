---
import { Icon } from "astro-icon/components";
import Text from "@atoms/Text.astro";

// 1. LOGIQUE ENTIÈREMENT ENCAPSULÉE DANS L'ATOME
const { org } = Astro.locals;
let interactiveMapUrl: string | undefined;
let mapAriaLabel: string | undefined;

if (org) {
  // Priorité 1: Coordonnées GEO
  if (org.geo && typeof org.geo === 'object' && 'latitude' in org.geo && 'longitude' in org.geo) {
    const lat = org.geo.latitude;
    const lon = org.geo.longitude;
    interactiveMapUrl = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=15/${lat}/${lon}`;
  }
  // Priorité 2: Adresse complète
  else if (org.streetaddress) {
    const fullAddress = `${org.streetaddress}, ${org.postalCode ?? ''} ${org.addressLocality ?? ''}, ${org.addressCountry ?? ''}`;
    interactiveMapUrl = `https://www.openstreetmap.org/search?query=${encodeURIComponent(fullAddress.trim())}`;
  }

  // Préparation du label pour l'accessibilité
  if (interactiveMapUrl) {
    mapAriaLabel = `Voir ${org.name ?? 'notre localisation'} sur une carte interactive`;
  }
}
---

<!-- 2. L'ATOME DÉCIDE SEUL DE S'AFFICHER ET NE REND QUE LE LIEN <a> -->
{interactiveMapUrl && (
  <a 
    href={interactiveMapUrl} 
    target="_blank" 
    rel="noopener noreferrer" 
    aria-label={mapAriaLabel}
    class="static-map-placeholder"
  >
    <div class="map-icon-container">
      <Icon name="mdi:map-marker-radius-outline" />
    </div>
    <Text tag="span" class="map-text">
      Cliquer pour voir la carte
    </Text>
  </a>
)}

<style>
  .static-map-placeholder {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    background-color: var(--color-muted, #e9ecef);
    color: var(--color-text, #333);
    text-decoration: none;
    border-radius: inherit;
    transition: background-color 0.2s ease, color 0.2s ease;
    text-align: center;
    padding: 2rem;
    box-sizing: border-box;
  }
  .static-map-placeholder:hover {
    background-color: var(--color-muted-dark, #ced4da);
    color: var(--color-text-dark, #000);
  }
  .map-icon-container { font-size: 4rem; line-height: 1; margin-bottom: 1rem; }
  .map-text { font-weight: bold; }
</style>